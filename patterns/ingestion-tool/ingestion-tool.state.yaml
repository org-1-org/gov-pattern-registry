# ingestion-tool.state.yaml
# Pattern: Generic data ingestion tool state description
# Version: 0.1.0
#
# DESCRIPTIVE ONLY - This is not runtime state.
# Documents expected instantiation parameters and operational characteristics.

kind: state
version: "0.1.0"
level: project

metadata:
  name: ingestion-tool
  description: |
    Descriptive state for ingestion tool instantiations.
    NOT runtime state - describes expected configuration shape and
    operational characteristics when the pattern is instantiated.

# -----------------------------------------------------------------------------
# Instantiation Parameters
# -----------------------------------------------------------------------------
# These are the expected fields an instantiation should define.

instantiation_parameters:
  supported_sources:
    description: |
      List of source providers this instantiation connects to.
      Examples: gmail, stripe, salesforce, postgres
    type: list[str]
    required: true

  supported_streams:
    description: |
      Map of stream names to their source and object type.
      Each stream represents one extractable data type from a source.
    type: map[str, StreamConfig]
    required: true
    example:
      gmail_messages:
        provider: gmail
        stream: messages
      stripe_customers:
        provider: stripe
        stream: customers

  credential_backend:
    description: |
      How credentials are stored and retrieved.
      Examples: authctl, vault, env, aws-secrets-manager
    type: str
    required: true

  default_checkpoint_kind:
    description: |
      Where checkpoint/cursor state is stored.
      Since thin ingestion tools delegate this to consumers, this may be "none"
      or describe the consumer's mechanism.
    type: str
    required: false
    default: "consumer-managed"
    examples:
      - none (stateless, consumer manages)
      - file (local JSON/YAML)
      - database (postgres, sqlite)
      - redis

  default_output_kind:
    description: |
      How records are emitted to consumers.
      Examples: iterator, callback, queue, file
    type: str
    required: false
    default: "iterator"

  token_cache_location:
    description: |
      Where OAuth/session tokens are cached for refresh.
    type: str
    required: false
    example: ".tokens/"

# -----------------------------------------------------------------------------
# Operational Notes
# -----------------------------------------------------------------------------
# Guidance for operators deploying instantiations of this pattern.

operational_notes:
  deployment:
    - Pattern instantiations are typically libraries, not standalone services
    - May be embedded in orchestrator/scheduler processes
    - No persistent storage required (stateless)

  scaling:
    - Single-threaded extraction per stream (provider rate limits)
    - Parallelism achieved by running multiple streams concurrently
    - Memory bounded by largest single record (streaming, not batch)

  monitoring:
    - Log aggregation recommended for extraction events
    - Metrics for record counts and extraction duration
    - Alert on sustained auth failures

  maintenance:
    - Credential rotation via credential backend (no code changes)
    - Provider API version updates may require adapter updates
    - Token caches may need periodic cleanup

# -----------------------------------------------------------------------------
# State Transitions (Descriptive)
# -----------------------------------------------------------------------------
# How an ingestion tool conceptually moves through states during extraction.

state_transitions:
  - name: idle
    description: No extraction in progress
    transitions_to: [authenticating]

  - name: authenticating
    description: Loading credentials and building client
    transitions_to: [extracting, auth_failed]

  - name: extracting
    description: Streaming records from source
    transitions_to: [idle, rate_limited, extract_failed]

  - name: rate_limited
    description: Waiting for rate limit backoff
    transitions_to: [extracting, extract_failed]

  - name: auth_failed
    description: Authentication failed after retries
    transitions_to: [idle]
    terminal: true

  - name: extract_failed
    description: Extraction failed after retries
    transitions_to: [idle]
    terminal: true

# -----------------------------------------------------------------------------
# Health Indicators
# -----------------------------------------------------------------------------
health_indicators:
  healthy:
    - Credentials load successfully
    - Token refresh works (if applicable)
    - At least one record extracted in test window

  degraded:
    - Frequent rate limit hits
    - Token refresh taking multiple attempts
    - High error rate on individual records

  unhealthy:
    - Credential load fails
    - Token refresh fails
    - All extraction attempts fail
